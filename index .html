<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chess Pro Jr — Random ECO + Depth Control</title>
<style>
:root{
  --bg:#0b1020;--panel:#0f1724;--light:#f0d9b5;--dark:#b58863;
  --accent:#16a34a;--muted:#94a3b8;
  --white-piece:#fff;--black-piece:#000;
  --lastmove:rgba(255,215,0,0.35);--select:rgba(34,197,94,0.45)
}
html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:Inter,system-ui,"Segoe UI",Roboto,Arial}
.app{min-height:100vh;display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px}
.topbar{display:flex;justify-content:space-between;align-items:center;width:100%;
  background:#fff;color:#000;padding:10px 12px;border-radius:10px;
  box-shadow:0 6px 20px rgba(2,6,23,0.35)}
.board-wrap{display:flex;justify-content:center;align-items:center;width:100%}
#board{width:min(96vw,720px);aspect-ratio:1/1;display:grid;
  grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr);
  border-radius:10px;overflow:hidden;box-shadow:0 18px 40px rgba(2,6,23,0.55)}
.square{display:flex;align-items:center;justify-content:center;
  font-size:calc(9vmin);transition:background .1s,outline .1s}
.light{background:var(--light)}.dark{background:var(--dark)}
.piece{width:100%;height:100%;text-align:center;line-height:1.1}
.white{color:var(--white-piece)}.black{color:var(--black-piece)}
.selected{outline:5px solid var(--select)}.last{background:var(--lastmove)}
.controls{display:flex;flex-wrap:wrap;justify-content:center;gap:10px}
.btn{background:var(--panel);color:#fff;border:0;padding:10px 12px;border-radius:8px;
  font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(2,6,23,0.45)}
.btn.primary{background:var(--accent)}
#depthBar{font-size:14px;color:var(--muted)}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="brand">♟ Chess Pro Jr — ECO + Depth</div>
    <div id="engineStatus">Engine initializing…</div>
  </div>

  <div class="board-wrap"><div id="board"></div></div>
  <div id="depthBar">Depth – Eval –</div>

  <div class="controls">
    <button id="newBtn" class="btn primary">New Game</button>
    <button id="switchBtn" class="btn">Switch Sides</button>
    <button id="undoBtn" class="btn">Undo</button>
    <button id="depthBtn" class="btn">Depth: 8</button>
  </div>
</div>

<script src="chess.min.js"></script>
<script>
const board=document.getElementById('board'),
      status=document.getElementById('engineStatus'),
      depthBar=document.getElementById('depthBar'),
      depthBtn=document.getElementById('depthBtn');
let game=new Chess(),playerColor='w',lastMoveSquares=[],selected=null;
let sfWorker,stockfishAvailable=false,openingBook={};
let engineDepth=8;
const U={'K':'♔','Q':'♕','R':'♖','B':'♗','N':'♘','P':'♙','k':'♚','q':'♛','r':'♜','b':'♝','n':'♞','p':'♟'};
function random(a){return a[Math.floor(Math.random()*a.length)]}
function bookKey(hist){const t=new Chess(),u=[];for(const s of hist){const m=t.move(s,{sloppy:true});if(!m)break;u.push(m.from+m.to+(m.promotion||''));}return u.join('');}
function findBookMove(hist){const k=bookKey(hist);if(openingBook[k])return random(openingBook[k]);
 let best=null,l=0;for(const bk in openingBook){if(k.startsWith(bk)&&bk.length>l){best=bk;l=bk.length;}}
 return best?random(openingBook[best]):null;}

async function loadECO(){
 try{
   const r=await fetch('eco.json');const j=await r.json();
   for(const k in j){openingBook[k]=Array.isArray(j[k])?j[k]:[j[k]];}
   status.textContent='Engine: Stockfish + ECO ready';
   console.log('ECO entries:',Object.keys(openingBook).length);
 }catch(e){status.textContent='Engine: ECO missing';}
}
loadECO();

function buildBoard(){
 board.innerHTML='';
 const f=['a','b','c','d','e','f','g','h'];
 const r=playerColor==='w'?[8,7,6,5,4,3,2,1]:[1,2,3,4,5,6,7,8];
 for(let R of r){for(let F of(playerColor==='w'?f:[...f].reverse())){
   const sq=F+R,d=document.createElement('div');
   d.className='square '+(((F.charCodeAt(0)-97)+(R-1))%2===0?'light':'dark');
   d.dataset.sq=sq;d.onclick=()=>tap(sq);board.appendChild(d);
 }}
 render();
}
function render(){
 document.querySelectorAll('.square').forEach(d=>{
   d.innerHTML='';d.classList.remove('selected','last');
   const p=game.get(d.dataset.sq);
   if(p){const el=document.createElement('div');
     el.className='piece '+(p.color==='w'?'white':'black');
     el.textContent=U[p.color==='w'?p.type.toUpperCase():p.type];d.appendChild(el);}
   if(lastMoveSquares.includes(d.dataset.sq))d.classList.add('last');
 });
}
function highlight(sq){render();const el=[...board.children].find(x=>x.dataset.sq===sq);if(el)el.classList.add('selected');}
function tap(sq){
 if(!selected){const p=game.get(sq);if(p&&p.color===playerColor){selected=sq;highlight(sq);}return;}
 if(selected===sq){selected=null;render();return;}
 const mv=game.move({from:selected,to:sq,promotion:'q'});
 if(mv){lastMoveSquares=[selected,sq];selected=null;render();if(!game.game_over())setTimeout(computerMove,150);}
 else{const p=game.get(sq);if(p&&p.color===playerColor){selected=sq;highlight(sq);}else{selected=null;render();}}
}

function initSF(){
 try{
   sfWorker=new Worker('stockfish.js');
   sfWorker.onmessage=e=>{
     const t=e.data?.toString();
     if(t.includes('uciok')){stockfishAvailable=true;}
     if(t.includes('depth')){
       const d=t.match(/depth\s+(\d+)/),ev=t.match(/score\s+cp\s+(-?\d+)/);
       if(d){let evalTxt='';if(ev){const val=(parseInt(ev[1])/100).toFixed(2);evalTxt=`Eval ${val}`;}
       depthBar.textContent=`Depth ${d[1]} • ${evalTxt}`;}
     }
   };
   sfWorker.postMessage('uci');
   status.textContent='Engine: Stockfish loading…';
 }catch(e){status.textContent='Engine: unavailable';}
}
initSF();
function sendSF(c){if(sfWorker)sfWorker.postMessage(c);}
function toUCI(h){const t=new Chess(),u=[];for(const s of h){const m=t.move(s,{sloppy:true});if(!m)break;u.push(m.from+m.to+(m.promotion||''));}return u.join(' ');}
async function getBest(uci,depth){
 return new Promise((res,rej)=>{
   let best=null;
   const on=e=>{
     const t=e.data?.toString();
     if(t.includes('bestmove')){
       const m=t.match(/bestmove\s+([a-h][1-8][a-h][1-8][qrbn]?)/);
       if(m){best=m[1];sfWorker.removeEventListener('message',on);res(best);}
     }
   };
   sfWorker.addEventListener('message',on);
   sendSF('stop');sendSF('ucinewgame');
   if(uci)sendSF('position startpos moves '+uci);
   sendSF('go depth '+depth);
   setTimeout(()=>rej('timeout'),45000);
 });
}

async function computerMove(){
 const hist=game.history();const book=findBookMove(hist);
 if(book){
   console.log('📘 Random Book move:',book);
   game.move({from:book.slice(0,2),to:book.slice(2,4),promotion:book[4]});
   lastMoveSquares=[book.slice(0,2),book.slice(2,4)];render();return;
 }
 if(!stockfishAvailable)return;
 const best=await getBest(toUCI(hist),engineDepth);
 if(best){game.move({from:best.slice(0,2),to:best.slice(2,4),promotion:best[4]});
   lastMoveSquares=[best.slice(0,2),best.slice(2,4)];render();}
}

document.getElementById('newBtn').onclick=()=>{game.reset();lastMoveSquares=[];render();depthBar.textContent='Depth – Eval –';};
document.getElementById('switchBtn').onclick=()=>{playerColor=(playerColor==='w'?'b':'w');buildBoard();};
document.getElementById('undoBtn').onclick=()=>{game.undo();game.undo();render();};

// depth switcher
depthBtn.onclick=()=>{
 const depths=[4,6,8,10,12,14,16,18,20];
 const i=(depths.indexOf(engineDepth)+1)%depths.length;
 engineDepth=depths[i];
 depthBtn.textContent='Depth: '+engineDepth;
};
buildBoard();
</script>
</body>
</html>